language: node_js

node_js:
  - node

branches:
  except:
  - /^v?\d+\.\d+\.\d+$/

before_install:
  - git describe --debug
  - "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json; git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; } | tr \"\\n\" \" \""
  # If package.json major and minor versions match last tag, then increment last tag. Else use package.json major.minor.0.
  - "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json; git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; } | tr \"\\n\" \" \" | awk '{printf($1==$2?\"v\"$2$3+1:\"v\"$1\"0\")}' | xargs -I {} git tag -a {} -m \"{}\"\n"
  - echo Version from git $(git describe --abbrev=0)
  - npm --no-git-tag-version --allow-same-version version from-git
  - echo Version from package.json $(node -p "require('./package.json').version")
  - yarn config set ignore-engines true

deploy:
  - provider: script
    skip_cleanup: true
    script: git push --tags
    on:
      branch: master
  - provider: npm
    email: "paul.heasley@gmail.com"
    api_key: $NPM_TOKEN
    on:
      branch: master
